<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Online SMAN 1 MOTUI - Multi User</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sman1motui-app';

        // Global State
        window.state = {
            user: null,
            siswa: [],
            absensi: [],
            settings: { 
                jamMasuk: "07:30",
                jamPulang: "14:00",
                systemDate: new Date().toISOString().split('T')[0],
                msgTepat: "Pemberitahuan: [nama] ([kelas]) telah hadir TEPAT WAKTU pada pukul [waktu] tanggal [tanggal].",
                msgTelat: "Peringatan: [nama] ([kelas]) hadir TERLAMBAT pada pukul [waktu] tanggal [tanggal]. Mohon diingatkan.",
                msgPulang: "Info: [nama] ([kelas]) telah melakukan absen PULANG pada pukul [waktu]. Terima kasih.",
                msgBolos: "PENTING: [nama] ([kelas]) TIDAK TERDETEKSI melakukan absensi hingga saat ini (tanggal [tanggal]). Mohon konfirmasi."
            },
            currentTab: 'dashboard',
            currentRekapTab: 'masuk'
        };

        // --- AUTHENTICATION ---
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth error:", error);
                alert("Gagal terhubung ke server cloud.");
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.state.user = user;
                document.getElementById('user-id-display').innerText = `ID Petugas: ${user.uid.substring(0,8)}`;
                initDataListeners();
            }
        });

        // --- FIRESTORE LISTENERS (Real-time Sync) ---
        function initDataListeners() {
            if (!window.state.user) return;

            // 1. Settings Listener
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings'), (docSnap) => {
                if (docSnap.exists()) {
                    window.state.settings = docSnap.data();
                    updateClock();
                    if (window.state.currentTab === 'settings') loadSettingsToUI();
                } else {
                    // Initialize default settings if not exists
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings'), window.state.settings);
                }
            }, (err) => console.error("Settings listener err:", err));

            // 2. Siswa Listener
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'siswa'), (querySnapshot) => {
                window.state.siswa = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, (err) => console.error("Siswa listener err:", err));

            // 3. Absensi Listener
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'absensi'), (querySnapshot) => {
                window.state.absensi = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => b.timestamp - a.timestamp);
                renderAll();
            }, (err) => console.error("Absensi listener err:", err));
        }

        // --- ACTIONS ---
        window.saveSiswaCloud = async (siswaData) => {
            if (!window.state.user) return;
            const editId = document.getElementById('edit-index').value;
            if (editId === "-1") {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'siswa'), siswaData);
            } else {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'siswa', editId), siswaData);
            }
        };

        window.deleteSiswaCloud = async (id) => {
            if (!window.state.user) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'siswa', id));
        };

        window.saveAbsensiCloud = async (absenData) => {
            if (!window.state.user) return;
            absenData.timestamp = Date.now();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'absensi'), absenData);
        };

        window.updateSettingsCloud = async (newSettings) => {
            if (!window.state.user) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings'), newSettings);
        };

        window.clearRekapCloud = async () => {
            if (!window.state.user) return;
            const batch = writeBatch(db);
            window.state.absensi.forEach(item => {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'absensi', item.id);
                batch.delete(docRef);
            });
            await batch.commit();
        };

        // Start Auth
        initAuth();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: 600; }
        #reader { border-radius: 1rem; overflow: hidden; border: none !important; background: #000; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            body * { visibility: hidden; }
            #modal-qr, #modal-qr * { visibility: visible; }
            #modal-qr { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-blue-800 text-white p-6 shadow-lg">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="bg-white p-2 rounded-full shadow-inner">
                    <i class="fas fa-school text-blue-800 text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">SMAN 1 MOTUI</h1>
                    <p id="user-id-display" class="text-[10px] opacity-70 font-mono">Menghubungkan...</p>
                </div>
            </div>
            <div class="text-right">
                <div id="activeDateDisplay" class="text-sm font-semibold opacity-90 italic"></div>
                <div id="currentTime" class="text-2xl font-bold tracking-widest"></div>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex overflow-x-auto no-scrollbar">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 px-2 text-center text-sm tab-active min-w-[80px]">
                <i class="fas fa-home block mb-1"></i> Beranda
            </button>
            <button onclick="switchTab('scan')" id="tab-scan" class="flex-1 py-4 px-2 text-center text-sm text-gray-500 min-w-[80px]">
                <i class="fas fa-qrcode block mb-1"></i> Scan QR
            </button>
            <button onclick="switchTab('siswa')" id="tab-siswa" class="flex-1 py-4 px-2 text-center text-sm text-gray-500 min-w-[80px]">
                <i class="fas fa-users block mb-1"></i> Siswa
            </button>
            <button onclick="switchTab('rekap')" id="tab-rekap" class="flex-1 py-4 px-2 text-center text-sm text-gray-500 min-w-[80px]">
                <i class="fas fa-file-alt block mb-1"></i> Rekap
            </button>
            <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-4 px-2 text-center text-sm text-gray-500 min-w-[80px]">
                <i class="fas fa-cog block mb-1"></i> Atur
            </button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 mb-20">

        <!-- DASHBOARD -->
        <section id="content-dashboard" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-6 border-l-4 border-green-500">
                    <p class="text-gray-500 text-sm font-medium">Hadir Tepat Waktu</p>
                    <h3 id="stat-tepat" class="text-3xl font-bold text-green-600">0</h3>
                </div>
                <div class="glass-card p-6 border-l-4 border-red-500">
                    <p class="text-gray-500 text-sm font-medium">Terlambat</p>
                    <h3 id="stat-telat" class="text-3xl font-bold text-red-600">0</h3>
                </div>
            </div>
            <div class="glass-card p-6">
                <h4 class="font-bold mb-4 flex items-center text-gray-700">
                    <i class="fas fa-history mr-2 text-blue-600"></i> Aktivitas Log (Live)
                </h4>
                <div id="recent-list" class="space-y-3"></div>
            </div>
        </section>

        <!-- SCAN QR -->
        <section id="content-scan" class="hidden space-y-4">
            <div class="glass-card p-4 text-center">
                <h2 class="text-lg font-bold mb-2 text-gray-800">Pindai QR Kode</h2>
                <div class="relative mx-auto max-w-sm overflow-hidden rounded-2xl shadow-2xl border-4 border-white mb-4">
                    <div id="reader" style="width: 100%; min-height: 300px;"></div>
                </div>
                <div id="scan-feedback" class="mt-4 hidden p-3 rounded-xl bg-green-500 text-white font-bold animate-pulse">BERHASIL!</div>
            </div>
        </section>

        <!-- DATA SISWA -->
        <section id="content-siswa" class="hidden space-y-4">
            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="form-siswa-title" class="font-bold text-lg text-blue-800">Manajemen Siswa</h2>
                    <div class="flex space-x-2">
                        <button onclick="downloadSampleExcel()" class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg text-xs font-bold">FORMAT</button>
                        <label class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold cursor-pointer hover:bg-blue-700">
                            IMPOR
                            <input type="file" class="hidden" accept=".xlsx, .xls" onchange="importFromExcel(event)">
                        </label>
                    </div>
                </div>
                <input type="hidden" id="edit-index" value="-1">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="inputNama" placeholder="Nama Lengkap" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="inputKelas" placeholder="Kelas" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="inputNIS" placeholder="NIS / ID QR" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="tel" id="inputHpOrtu" placeholder="WhatsApp Ortu (628...)" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex space-x-2">
                    <button id="btnSaveSiswa" onclick="saveSiswa()" class="flex-1 bg-blue-700 text-white py-3 rounded-xl font-bold hover:bg-blue-800">Simpan Ke Cloud</button>
                    <button id="btnCancelEdit" onclick="resetFormSiswa()" class="hidden bg-gray-400 text-white py-3 px-6 rounded-xl font-bold">Batal</button>
                </div>
            </div>
            
            <div class="glass-card overflow-hidden">
                <div class="p-4 bg-blue-50 border-b">
                    <h3 class="font-bold text-sm text-blue-800">Database Siswa Terpusat</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 text-xs font-bold uppercase text-gray-500">Siswa / Kelas</th>
                                <th class="p-4 text-xs font-bold uppercase text-gray-500 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="siswa-table-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- REKAPITULASI -->
        <section id="content-rekap" class="hidden space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h2 class="font-bold text-xl text-gray-800">Rekapitulasi Global</h2>
                <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center hover:bg-green-700">
                    <i class="fas fa-file-excel mr-2"></i> EXPORT DATA
                </button>
            </div>

            <div class="flex bg-gray-200 p-1 rounded-xl">
                <button onclick="switchRekapTab('masuk')" id="btn-rekap-masuk" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow text-blue-800">MASUK</button>
                <button onclick="switchRekapTab('pulang')" id="btn-rekap-pulang" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-600">PULANG</button>
                <button onclick="switchRekapTab('tidak-hadir')" id="btn-rekap-tidak-hadir" class="flex-1 py-2 text-xs font-bold rounded-lg text-gray-600">TIDAK HADIR</button>
            </div>

            <div id="rekap-list-content" class="space-y-4"></div>
        </section>

        <!-- PENGATURAN -->
        <section id="content-settings" class="hidden space-y-6">
            <div class="glass-card p-6">
                <h2 class="font-bold text-lg mb-4 text-gray-800 border-b pb-2"><i class="fas fa-calendar-alt mr-2 text-blue-600"></i>Sinkronisasi Cloud</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Tanggal Absensi</label>
                        <input type="date" id="setSystemDate" class="w-full p-3 border rounded-xl">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Batas Telat</label>
                        <input type="time" id="setJamMasuk" class="w-full p-3 border rounded-xl">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Jam Pulang</label>
                        <input type="time" id="setJamPulang" class="w-full p-3 border rounded-xl">
                    </div>
                </div>
                <button onclick="saveSettings()" class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold mt-6">UPDATE PENGATURAN (SEMUA USER)</button>
            </div>
        </section>

    </main>

    <!-- Modal Notification -->
    <div id="modal-notif" class="fixed inset-0 bg-black/70 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center">
            <div id="modal-icon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl"></div>
            <h2 id="modal-title" class="text-xl font-bold mb-2"></h2>
            <p id="modal-desc" class="text-gray-500 mb-6 text-sm"></p>
            <button onclick="closeModal()" class="w-full bg-blue-700 text-white py-4 rounded-2xl font-bold">OK</button>
        </div>
    </div>

    <!-- Modal Konfirmasi -->
    <div id="modal-confirm" class="fixed inset-0 bg-black/70 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center">
            <div class="w-16 h-16 rounded-full bg-red-100 text-red-600 flex items-center justify-center mx-auto mb-4 text-3xl"><i class="fas fa-trash-alt"></i></div>
            <h2 class="text-xl font-bold mb-2">Hapus Rekap Cloud?</h2>
            <p class="text-gray-500 mb-6 text-sm">Semua petugas akan kehilangan data ini.</p>
            <div class="flex space-x-2">
                <button onclick="closeConfirmModal()" class="flex-1 bg-gray-200 py-3 rounded-2xl font-bold">BATAL</button>
                <button onclick="handleClearRekap()" class="flex-1 bg-red-600 text-white py-3 rounded-2xl font-bold">HAPUS</button>
            </div>
        </div>
    </div>

    <!-- Modal QR -->
    <div id="modal-qr" class="fixed inset-0 bg-black/80 z-[110] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 max-w-xs w-full text-center relative">
            <button onclick="closeQRModal()" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times text-xl"></i></button>
            <h3 id="qr-modal-name" class="font-bold text-blue-800 mb-1">Nama Siswa</h3>
            <div id="qrcode-container" class="flex justify-center my-6"></div>
            <button onclick="window.print()" class="w-full bg-gray-100 py-3 rounded-xl font-bold mb-2">CETAK</button>
        </div>
    </div>

    <script>
        const html5QrCode = new Html5Qrcode("reader");

        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').innerText = now.toLocaleTimeString('id-ID', { hour12: false });
            const sysDate = new Date(window.state.settings.systemDate);
            document.getElementById('activeDateDisplay').innerText = sysDate.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        }
        setInterval(updateClock, 1000);

        async function switchTab(tabId) {
            if (window.state.currentTab === 'scan') await html5QrCode.stop().catch(() => {});
            
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active', 'text-blue-800'));
            
            document.getElementById('content-' + tabId).classList.remove('hidden');
            document.getElementById('tab-' + tabId).classList.add('tab-active', 'text-blue-800');
            window.state.currentTab = tabId;
            
            if (tabId === 'scan') {
                html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, onScanSuccess);
            }
            renderAll();
        }

        function onScanSuccess(decodedText) {
            const targetSiswa = window.state.siswa.find(s => s.nis === decodedText);
            if (!targetSiswa) return;

            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const type = timeStr >= window.state.settings.jamPulang ? 'PULANG' : 'MASUK';
            
            const exists = window.state.absensi.find(a => a.nis === decodedText && a.tanggal === window.state.settings.systemDate && a.tipe === type);
            if (exists) return;

            let status = type === 'MASUK' ? (timeStr > window.state.settings.jamMasuk ? 'Terlambat' : 'Tepat Waktu') : 'Pulang';

            window.saveAbsensiCloud({
                nama: targetSiswa.nama, kelas: targetSiswa.kelas, nis: targetSiswa.nis, hp: targetSiswa.hp,
                waktu: timeStr, tanggal: window.state.settings.systemDate, status: status, tipe: type
            });

            document.getElementById('scan-feedback').classList.remove('hidden');
            setTimeout(() => document.getElementById('scan-feedback').classList.add('hidden'), 2000);
        }

        async function saveSiswa() {
            const s = {
                nama: document.getElementById('inputNama').value.trim(),
                kelas: document.getElementById('inputKelas').value.trim(),
                nis: document.getElementById('inputNIS').value.trim(),
                hp: document.getElementById('inputHpOrtu').value.trim()
            };
            if (!s.nama || !s.nis) return;
            await window.saveSiswaCloud(s);
            resetFormSiswa();
            showMessage("Berhasil", "Data siswa tersinkronisasi ke Cloud.", "success");
        }

        function resetFormSiswa() {
            ["inputNama", "inputKelas", "inputNIS", "inputHpOrtu"].forEach(id => document.getElementById(id).value = "");
            document.getElementById('edit-index').value = "-1";
            document.getElementById('btnCancelEdit').classList.add('hidden');
        }

        function editSiswa(id) {
            const s = window.state.siswa.find(x => x.id === id);
            document.getElementById('inputNama').value = s.nama;
            document.getElementById('inputKelas').value = s.kelas;
            document.getElementById('inputNIS').value = s.nis;
            document.getElementById('inputHpOrtu').value = s.hp;
            document.getElementById('edit-index').value = id;
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        async function hapusSiswa(id) {
            if(confirm("Hapus siswa dari Cloud?")) await window.deleteSiswaCloud(id);
        }

        function switchRekapTab(tabId) {
            window.state.currentRekapTab = tabId;
            document.querySelectorAll('#btn-rekap-masuk, #btn-rekap-pulang, #btn-rekap-tidak-hadir').forEach(b => {
                b.classList.remove('bg-white', 'shadow', 'text-blue-800');
            });
            document.getElementById('btn-rekap-' + tabId).classList.add('bg-white', 'shadow', 'text-blue-800');
            renderRekapList();
        }

        async function saveSettings() {
            const newSets = {...window.state.settings};
            newSets.systemDate = document.getElementById('setSystemDate').value;
            newSets.jamMasuk = document.getElementById('setJamMasuk').value;
            newSets.jamPulang = document.getElementById('setJamPulang').value;
            await window.updateSettingsCloud(newSets);
            showMessage("Berhasil", "Pengaturan global diperbarui.", "success");
        }

        function loadSettingsToUI() {
            document.getElementById('setSystemDate').value = window.state.settings.systemDate;
            document.getElementById('setJamMasuk').value = window.state.settings.jamMasuk;
            document.getElementById('setJamPulang').value = window.state.settings.jamPulang;
        }

        function renderAll() {
            const logsToday = window.state.absensi.filter(a => a.tanggal === window.state.settings.systemDate);
            document.getElementById('stat-tepat').innerText = logsToday.filter(a => a.status === 'Tepat Waktu').length;
            document.getElementById('stat-telat').innerText = logsToday.filter(a => a.status === 'Terlambat').length;

            const recentList = document.getElementById('recent-list');
            recentList.innerHTML = logsToday.slice(0, 8).map(a => `
                <div class="p-3 bg-white flex justify-between items-center rounded-lg shadow-sm border-l-2 border-blue-500">
                    <div>
                        <p class="font-bold text-sm text-gray-800">${a.nama}</p>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">${a.tipe} • ${a.waktu}</p>
                    </div>
                    <i class="fas fa-sync text-blue-300 text-xs"></i>
                </div>
            `).join('') || '<p class="text-center text-gray-400 py-4 text-xs italic">Menunggu data absensi...</p>';

            const siswaTable = document.getElementById('siswa-table-body');
            siswaTable.innerHTML = window.state.siswa.map((s) => `
                <tr>
                    <td class="p-4">
                        <div class="font-bold text-sm text-gray-800">${s.nama}</div>
                        <div class="text-[10px] text-blue-600 font-bold uppercase">${s.kelas}</div>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="showQRModal('${s.id}')" class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i class="fas fa-qrcode"></i></button>
                            <button onclick="editSiswa('${s.id}')" class="p-2 bg-yellow-100 text-yellow-600 rounded-lg"><i class="fas fa-edit"></i></button>
                            <button onclick="hapusSiswa('${s.id}')" class="p-2 bg-red-100 text-red-600 rounded-lg"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');

            renderRekapList();
        }

        function renderRekapList() {
            const listContainer = document.getElementById('rekap-list-content');
            const logsToday = window.state.absensi.filter(a => a.tanggal === window.state.settings.systemDate);
            let html = "";
            let displayData = [];

            if (window.state.currentRekapTab === 'masuk') {
                displayData = logsToday.filter(a => a.tipe === 'MASUK');
            } else if (window.state.currentRekapTab === 'pulang') {
                displayData = logsToday.filter(a => a.tipe === 'PULANG');
            } else {
                const hasAbsenNis = new Set(logsToday.filter(l => l.tipe === 'MASUK').map(l => l.nis));
                displayData = window.state.siswa.filter(s => !hasAbsenNis.has(s.nis));
                html += `<button onclick="confirmClearRekap()" class="w-full mb-4 bg-red-50 text-red-600 py-3 rounded-xl text-xs font-bold border border-red-100">KOSONGKAN DATA CLOUD</button>`;
            }

            html += displayData.map(item => `
                <div class="glass-card flex justify-between items-center p-4">
                    <div>
                        <p class="font-bold text-sm text-gray-800">${item.nama}</p>
                        <p class="text-[10px] text-gray-400 uppercase font-bold">
                            ${window.state.currentRekapTab === 'tidak-hadir' ? item.kelas : `${item.status} • ${item.waktu}`}
                        </p>
                    </div>
                    <button onclick="sendWA('${item.nis}', '${window.state.currentRekapTab.toUpperCase()}')" class="bg-green-500 text-white p-2 rounded-full">
                        <i class="fab fa-whatsapp text-lg"></i>
                    </button>
                </div>
            `).join('') || `<p class="text-center text-gray-400 py-10 text-xs italic">Tidak ada data</p>`;

            listContainer.innerHTML = html;
        }

        async function handleClearRekap() {
            await window.clearRekapCloud();
            closeConfirmModal();
            showMessage("Sukses", "Data rekapitulasi di Cloud telah dikosongkan.", "success");
        }

        function confirmClearRekap() { document.getElementById('modal-confirm').classList.remove('hidden'); }
        function closeConfirmModal() { document.getElementById('modal-confirm').classList.add('hidden'); }

        function showQRModal(id) {
            const s = window.state.siswa.find(x => x.id === id);
            document.getElementById('qr-modal-name').innerText = s.nama;
            const container = document.getElementById('qrcode-container');
            container.innerHTML = "";
            new QRCode(container, { text: s.nis, width: 180, height: 180 });
            document.getElementById('modal-qr').classList.remove('hidden');
        }
        function closeQRModal() { document.getElementById('modal-qr').classList.add('hidden'); }

        function showMessage(t, d, type) {
            const icon = document.getElementById('modal-icon');
            icon.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl ${type === 'success' ? 'bg-green-100 text-green-600' : 'bg-blue-100 text-blue-600'}`;
            icon.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check' : 'fa-info'}"></i>`;
            document.getElementById('modal-title').innerText = t;
            document.getElementById('modal-desc').innerText = d;
            document.getElementById('modal-notif').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-notif').classList.add('hidden'); }

        function sendWA(nis, tipe) {
            const siswa = window.state.siswa.find(s => s.nis === nis);
            if (!siswa || !siswa.hp) return;
            const log = window.state.absensi.find(a => a.nis === nis && a.tanggal === window.state.settings.systemDate);
            const pesan = `Pemberitahuan Absensi ${tipe} untuk ${siswa.nama} (${siswa.kelas}).`;
            window.open(`https://api.whatsapp.com/send?phone=${siswa.hp}&text=${encodeURIComponent(pesan)}`, '_blank');
        }
    </script>
</body>
</html>
