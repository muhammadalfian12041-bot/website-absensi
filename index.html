<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi SMAN 1 MOTUI - Cloud Sync System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State Initialization
        window.state = {
            user: null,
            siswa: [],
            absensi: [],
            settings: { 
                jamMasuk: "07:30",
                jamPulang: "14:00",
                systemDate: new Date().toISOString().split('T')[0]
            },
            currentTab: 'dashboard'
        };

        // Konfigurasi Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sman1motui-cloud-v2';

        // --- AUTH & INITIALIZATION ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.state.user = user;
                const indicator = document.getElementById('cloud-indicator');
                if (indicator) {
                    indicator.innerHTML = `<span class="bg-green-500 w-2 h-2 rounded-full inline-block mr-1"></span> ID: ${user.uid.substring(0,6)}`;
                }
                startListeners();
            }
        });

        // --- REAL-TIME DATA SYNC ---
        function startListeners() {
            if (!window.state.user) return;

            // Sync Settings
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), (snap) => {
                if (snap.exists()) {
                    window.state.settings = snap.data();
                    if (typeof renderAll === 'function') renderAll();
                } else {
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), window.state.settings);
                }
            }, (error) => console.error("Settings listener error:", error));

            // Sync Siswa
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'siswa'), (snap) => {
                window.state.siswa = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (typeof renderAll === 'function') renderAll();
            }, (error) => console.error("Siswa listener error:", error));

            // Sync Absensi
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'absensi'), (snap) => {
                window.state.absensi = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => b.timestamp - a.timestamp);
                if (typeof renderAll === 'function') renderAll();
            }, (error) => console.error("Absensi listener error:", error));
        }

        // --- ACTIONS ---
        window.saveSiswaCloud = async (data) => {
            const id = document.getElementById('edit-id').value;
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'siswa');
            if (id === "-1") {
                await addDoc(colRef, data);
            } else {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'siswa', id), data);
            }
        };

        window.deleteSiswaCloud = async (id) => {
            if (confirm("Hapus data siswa ini?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'siswa', id));
            }
        };

        window.submitAbsenCloud = async (absenData) => {
            absenData.timestamp = Date.now();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'absensi'), absenData);
        };

        window.updateConfigCloud = async (config) => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), config);
        };

        initAuth();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .nav-active { color: #2563eb; background: #eff6ff; border-radius: 1rem; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        #reader { border-radius: 1rem; overflow: hidden; }
    </style>
</head>
<body class="pb-24">

    <!-- Header Section -->
    <div class="bg-blue-600 text-white px-6 pt-8 pb-16 rounded-b-[2.5rem] shadow-2xl relative overflow-hidden">
        <div class="absolute top-[-20%] right-[-10%] w-64 h-64 bg-blue-500 rounded-full opacity-20"></div>
        <div class="max-w-4xl mx-auto flex justify-between items-start">
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight">SMAN 1 MOTUI</h1>
                <p id="cloud-indicator" class="text-xs font-semibold opacity-80 mt-1 uppercase tracking-widest">Sistem Sedang Memuat...</p>
            </div>
            <div class="text-right">
                <div id="clock" class="text-2xl font-black tabular-nums">00:00</div>
                <div id="date" class="text-[10px] font-bold opacity-70 uppercase">Hari Ini</div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="max-w-4xl mx-auto px-4 -mt-8 relative z-10 space-y-6">

        <!-- DASHBOARD TAB -->
        <section id="tab-dashboard" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-5 rounded-3xl border-l-4 border-l-green-500">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Masuk Tepat</p>
                    <h3 id="stat-tepat" class="text-3xl font-black text-green-600">0</h3>
                </div>
                <div class="glass-card p-5 rounded-3xl border-l-4 border-l-red-500">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Terlambat</p>
                    <h3 id="stat-telat" class="text-3xl font-black text-red-600">0</h3>
                </div>
            </div>

            <div class="glass-card rounded-[2rem] overflow-hidden">
                <div class="p-6 border-b flex justify-between items-center bg-white/50">
                    <h2 class="font-extrabold text-sm"><i class="fas fa-history mr-2 text-blue-600"></i>Log Aktivitas Hari Ini</h2>
                    <span class="text-[9px] bg-blue-600 text-white px-2 py-1 rounded-full font-black animate-pulse">LIVE</span>
                </div>
                <div id="log-list" class="max-h-[350px] overflow-y-auto divide-y divide-gray-100">
                    <!-- Logs dynamically added here -->
                </div>
            </div>
        </section>

        <!-- SCANNER TAB -->
        <section id="tab-scan" class="hidden animate-in fade-in duration-300">
            <div class="glass-card p-8 rounded-[2.5rem] text-center">
                <div class="mb-6">
                    <h2 class="text-xl font-extrabold">Pindai QR Absensi</h2>
                    <p class="text-xs text-gray-400 mt-1 font-semibold">Pastikan kode QR berada di dalam area kotak</p>
                </div>
                <div id="reader" class="mx-auto max-w-sm aspect-square bg-black shadow-2xl border-4 border-white"></div>
                <div id="scan-success" class="hidden mt-6 p-4 bg-green-100 text-green-700 rounded-2xl font-bold animate-bounce">
                    <i class="fas fa-check-circle mr-2"></i> Absensi Berhasil Tercatat!
                </div>
            </div>
        </section>

        <!-- DATABASE SISWA TAB -->
        <section id="tab-siswa" class="hidden space-y-4">
            <div class="glass-card p-6 rounded-[2rem]">
                <h2 class="font-extrabold mb-4 text-gray-800">Tambah/Edit Siswa</h2>
                <input type="hidden" id="edit-id" value="-1">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">Nama Lengkap</label>
                        <input type="text" id="inNama" class="w-full bg-gray-50 p-4 rounded-2xl border-none ring-1 ring-gray-100 focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">Kelas</label>
                        <input type="text" id="inKelas" class="w-full bg-gray-50 p-4 rounded-2xl border-none ring-1 ring-gray-100 focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">Nomor Induk (NIS)</label>
                        <input type="text" id="inNIS" class="w-full bg-gray-50 p-4 rounded-2xl border-none ring-1 ring-gray-100 focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">WA Orang Tua (628...)</label>
                        <input type="tel" id="inWA" class="w-full bg-gray-50 p-4 rounded-2xl border-none ring-1 ring-gray-100 focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold">
                    </div>
                </div>
                <div class="flex gap-2 mt-6">
                    <button onclick="saveSiswa()" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all">Simpan Data</button>
                    <button id="cancel-edit" onclick="resetForm()" class="hidden bg-gray-200 text-gray-600 px-6 rounded-2xl font-bold">Batal</button>
                </div>
            </div>

            <div class="glass-card rounded-[2rem] overflow-hidden">
                <div id="siswa-list" class="divide-y divide-gray-50">
                    <!-- Student list here -->
                </div>
            </div>
        </section>

        <!-- PENGATURAN TAB -->
        <section id="tab-settings" class="hidden">
            <div class="glass-card p-6 rounded-[2rem] space-y-6">
                <div>
                    <h2 class="font-extrabold text-lg">Konfigurasi Cloud</h2>
                    <p class="text-xs text-gray-400 font-semibold">Pengaturan ini akan diterapkan di semua perangkat.</p>
                </div>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">Batas Jam Masuk</label>
                            <input type="time" id="setMasuk" class="w-full bg-gray-50 p-4 rounded-2xl border-none ring-1 ring-gray-100 outline-none text-sm font-bold">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">Jam Mulai Pulang</label>
                            <input type="time" id="setPulang" class="w-full bg-gray-50 p-4 rounded-2xl border-none ring-1 ring-gray-100 outline-none text-sm font-bold">
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 ml-2 uppercase">Tanggal Absensi Aktif</label>
                        <input type="date" id="setDate" class="w-full bg-gray-50 p-4 rounded-2xl border-none ring-1 ring-gray-100 outline-none text-sm font-bold">
                    </div>
                    <button onclick="updateSettings()" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold hover:shadow-2xl transition-all">Simpan Konfigurasi</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 glass-card mx-4 mb-4 p-2 rounded-2xl z-50 flex justify-around">
        <button onclick="switchTab('dashboard')" id="btn-dashboard" class="flex-1 flex flex-col items-center py-2 nav-active">
            <i class="fas fa-th-large text-lg"></i>
            <span class="text-[9px] font-extrabold mt-1">Status</span>
        </button>
        <button onclick="switchTab('scan')" id="btn-scan" class="flex-1 flex flex-col items-center py-2 text-gray-400">
            <i class="fas fa-qrcode text-lg"></i>
            <span class="text-[9px] font-extrabold mt-1">Scan</span>
        </button>
        <button onclick="switchTab('siswa')" id="btn-siswa" class="flex-1 flex flex-col items-center py-2 text-gray-400">
            <i class="fas fa-users-cog text-lg"></i>
            <span class="text-[9px] font-extrabold mt-1">Siswa</span>
        </button>
        <button onclick="switchTab('settings')" id="btn-settings" class="flex-1 flex flex-col items-center py-2 text-gray-400">
            <i class="fas fa-sliders-h text-lg"></i>
            <span class="text-[9px] font-extrabold mt-1">Atur</span>
        </button>
    </nav>

    <!-- QR Detail Modal -->
    <div id="qr-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[3rem] text-center w-full max-w-sm">
            <h4 id="qr-title" class="font-extrabold text-lg mb-1">Nama Siswa</h4>
            <p id="qr-subtitle" class="text-xs font-bold text-blue-600 mb-6 uppercase tracking-widest">KARTU ABSENSI DIGITAL</p>
            <div id="qr-canvas" class="p-4 bg-white border shadow-inner inline-block rounded-3xl mb-6"></div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('qr-modal').classList.add('hidden')" class="flex-1 bg-gray-100 py-4 rounded-2xl font-bold text-gray-500">Tutup</button>
                <button onclick="window.print()" class="flex-1 bg-blue-600 py-4 rounded-2xl font-bold text-white shadow-lg shadow-blue-200">Cetak</button>
            </div>
        </div>
    </div>

    <script>
        const scanner = new Html5Qrcode("reader");

        // UI Helpers
        function switchTab(id) {
            if (window.state && window.state.currentTab === 'scan') scanner.stop().catch(() => {});
            
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('nav-active', 'text-blue-600');
                b.classList.add('text-gray-400');
            });

            const targetSection = document.getElementById('tab-' + id);
            const targetBtn = document.getElementById('btn-' + id);
            
            if (targetSection) targetSection.classList.remove('hidden');
            if (targetBtn) {
                targetBtn.classList.add('nav-active', 'text-blue-600');
                targetBtn.classList.remove('text-gray-400');
            }
            
            if (window.state) window.state.currentTab = id;
            if (id === 'scan') startScanner();
            if (id === 'settings') loadSettingsToForm();
            renderAll();
        }

        function startScanner() {
            scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (decodedText) => {
                if (!window.state || !window.state.siswa) return;
                const siswa = window.state.siswa.find(s => s.nis === decodedText);
                if (!siswa) return;

                const now = new Date();
                const timeString = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
                const type = timeString >= window.state.settings.jamPulang ? 'PULANG' : 'MASUK';
                
                // Anti-Double Scan
                const already = window.state.absensi.find(a => a.nis === decodedText && a.tanggal === window.state.settings.systemDate && a.tipe === type);
                if (already) return;

                let status = "Hadir";
                if (type === 'MASUK') {
                    status = timeString > window.state.settings.jamMasuk ? 'Terlambat' : 'Tepat Waktu';
                }

                if (window.submitAbsenCloud) {
                    window.submitAbsenCloud({
                        nama: siswa.nama, nis: siswa.nis, kelas: siswa.kelas, hp: siswa.wa,
                        waktu: timeString, tanggal: window.state.settings.systemDate, tipe: type, status: status
                    });
                }

                document.getElementById('scan-success').classList.remove('hidden');
                setTimeout(() => document.getElementById('scan-success').classList.add('hidden'), 2500);
            }).catch(() => {});
        }

        // Logic Functions
        function saveSiswa() {
            const data = {
                nama: document.getElementById('inNama').value.trim(),
                kelas: document.getElementById('inKelas').value.trim(),
                nis: document.getElementById('inNIS').value.trim(),
                wa: document.getElementById('inWA').value.trim()
            };
            if (!data.nama || !data.nis) return;
            if (window.saveSiswaCloud) window.saveSiswaCloud(data);
            resetForm();
        }

        function editSiswa(id) {
            if (!window.state || !window.state.siswa) return;
            const s = window.state.siswa.find(x => x.id === id);
            if (!s) return;
            document.getElementById('inNama').value = s.nama;
            document.getElementById('inKelas').value = s.kelas;
            document.getElementById('inNIS').value = s.nis;
            document.getElementById('inWA').value = s.wa;
            document.getElementById('edit-id').value = id;
            document.getElementById('cancel-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            ['inNama','inKelas','inNIS','inWA'].forEach(i => {
                const el = document.getElementById(i);
                if (el) el.value = "";
            });
            document.getElementById('edit-id').value = "-1";
            const cancelBtn = document.getElementById('cancel-edit');
            if (cancelBtn) cancelBtn.classList.add('hidden');
        }

        function loadSettingsToForm() {
            if (!window.state || !window.state.settings) return;
            document.getElementById('setMasuk').value = window.state.settings.jamMasuk;
            document.getElementById('setPulang').value = window.state.settings.jamPulang;
            document.getElementById('setDate').value = window.state.settings.systemDate;
        }

        function updateSettings() {
            const config = {
                jamMasuk: document.getElementById('setMasuk').value,
                jamPulang: document.getElementById('setPulang').value,
                systemDate: document.getElementById('setDate').value
            };
            if (window.updateConfigCloud) window.updateConfigCloud(config);
        }

        function showQR(id) {
            if (!window.state || !window.state.siswa) return;
            const s = window.state.siswa.find(x => x.id === id);
            if (!s) return;
            document.getElementById('qr-title').innerText = s.nama;
            const container = document.getElementById('qr-canvas');
            container.innerHTML = "";
            new QRCode(container, { text: s.nis, width: 220, height: 220 });
            document.getElementById('qr-modal').classList.remove('hidden');
        }

        function renderAll() {
            if (!window.state || !window.state.settings || !window.state.absensi) return;

            const todayLogs = window.state.absensi.filter(a => a.tanggal === window.state.settings.systemDate);
            
            // Updates Clock
            const now = new Date();
            const clockEl = document.getElementById('clock');
            const dateEl = document.getElementById('date');
            if (clockEl) clockEl.innerText = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
            if (dateEl) dateEl.innerText = new Date(window.state.settings.systemDate).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short' });

            // Dashboard Stats
            const statTepat = document.getElementById('stat-tepat');
            const statTelat = document.getElementById('stat-telat');
            if (statTepat) statTepat.innerText = todayLogs.filter(l => l.status === 'Tepat Waktu').length;
            if (statTelat) statTelat.innerText = todayLogs.filter(l => l.status === 'Terlambat').length;

            // Log List
            const logEl = document.getElementById('log-list');
            if (logEl) {
                logEl.innerHTML = todayLogs.length ? todayLogs.slice(0, 15).map(l => `
                    <div class="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                        <div>
                            <p class="text-sm font-bold text-gray-800">${l.nama}</p>
                            <p class="text-[9px] font-black uppercase text-blue-500">${l.tipe} • ${l.status}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-black text-gray-900">${l.waktu}</p>
                            <p class="text-[9px] font-mono text-gray-400">${l.nis}</p>
                        </div>
                    </div>
                `).join('') : `<div class="p-12 text-center text-gray-300 italic text-xs">Belum ada aktivitas absensi hari ini</div>`;
            }

            // Siswa List
            const siswaEl = document.getElementById('siswa-list');
            if (siswaEl && window.state.siswa) {
                siswaEl.innerHTML = window.state.siswa.map(s => `
                    <div class="p-4 flex justify-between items-center">
                        <div onclick="showQR('${s.id}')" class="cursor-pointer group">
                            <p class="text-sm font-bold text-gray-800 group-hover:text-blue-600 transition-colors">${s.nama}</p>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">${s.kelas} • ${s.nis}</p>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editSiswa('${s.id}')" class="w-8 h-8 flex items-center justify-center bg-yellow-50 text-yellow-600 rounded-lg"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="window.deleteSiswaCloud('${s.id}')" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-600 rounded-lg"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                `).join('') || `<div class="p-12 text-center text-gray-300 italic text-xs">Database siswa kosong</div>`;
            }
        }

        // Initialize display and start loop
        window.addEventListener('DOMContentLoaded', () => {
            renderAll();
            setInterval(renderAll, 60000); 
        });
    </script>
</body>
</html>
